# ============================================
# Netlify Configuration - JudgeFinder Platform
# ============================================
# Production deployment configuration for Netlify
# Domain: judgefinder.io
# See: https://docs.netlify.com/configure-builds/file-based-configuration/
# ============================================

[build]
  command = "npm run build"
  # NOTE: Do NOT set 'publish' when using @netlify/plugin-nextjs
  # The plugin automatically manages the output directory for Next.js SSR
  # publish = ".next"  # Commented out - managed by Next.js plugin
  # NOTE: Do NOT set 'functions' when using @netlify/plugin-nextjs for API routes
  # The plugin automatically handles Next.js API routes as serverless functions
  # functions = "netlify/functions"  # Only for standalone Netlify functions (scheduled tasks)

  # Ignore builds for documentation changes only
  ignore = "git diff --quiet $CACHED_COMMIT_REF $COMMIT_REF . ':(exclude)docs/' ':(exclude)*.md'"

[build.environment]
  # Node.js and Build Configuration
  NODE_VERSION = "20"  # Match package.json requirement (^20 || ^22)
  # Legacy peer dependencies flag for compatibility
  NPM_FLAGS = "--legacy-peer-deps"
  NODE_ENV = "production"

  # Build Performance
  # Increase memory for Next.js build (default: 1024)
  NODE_OPTIONS = "--max-old-space-size=4096"

  # IMPORTANT: Set these in Netlify UI (Site settings > Environment variables)
  # ENCRYPTION_KEY - Required for secure data encryption in production
  # STRIPE_PRICE_MONTHLY - Stripe price ID for $500/month universal access
  # STRIPE_PRICE_YEARLY - Stripe price ID for $5,000/year universal access
  # STRIPE_PRICE_ADSPACE - (deprecated) Legacy price ID, use STRIPE_PRICE_MONTHLY

  # Public Environment Variables (safe for client-side, NEXT_PUBLIC_ prefix)
  NEXT_PUBLIC_APP_NAME = "JudgeFinder Platform"
  NEXT_PUBLIC_APP_URL = "https://judgefinder.io"
  NEXT_PUBLIC_CLERK_SIGN_IN_URL = "/sign-in"
  NEXT_PUBLIC_CLERK_SIGN_UP_URL = "/sign-up"
  NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL = "/dashboard"
  NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL = "/welcome"

  # Build Optimizations
  NEXT_TELEMETRY_DISABLED = "1"

  # ============================================
  # SECRETS SCANNING CONFIGURATION (CRITICAL)
  # ============================================
  # Prevent false positives in Netlify's secret scanner
  # These paths and keys are excluded from secret detection

  # Paths to exclude from secret scanning
  # Rationale for each exclusion:
  # - .netlify/**: Netlify internal build artifacts
  # - .next/**: Next.js build output (may contain bundled public keys)
  # - node_modules/**: Third-party dependencies
  # - .git/**: Git repository data
  # - coverage/**: Test coverage reports
  # - out/**, build/**, dist/**: Build artifacts
  # - .cache/**, .parcel-cache/**: Build caches
  # - *.tsbuildinfo: TypeScript incremental compilation info
  # - .eslintcache: ESLint cache
  # - *.log: Log files
  # - reports/**, validation-reports/**: Generated reports
  # - env_verification_report.json: Environment validation output
  # - tests-eslint.json, eslint-report.json: Linting reports
  # - .claude/**: IDE configuration files
  SECRETS_SCAN_OMIT_PATHS = ".netlify/**,.next/**,node_modules/**,.git/**,.cache/**,.parcel-cache/**,.eslintcache,*.tsbuildinfo,tsconfig.tsbuildinfo,coverage/**,out/**,build/**,dist/**,reports/**,validation-reports/**,*.log,logs/**,env_verification_report.json,tests-eslint.json,eslint-report.json,test-results/**,playwright-report/**,.playwright-mcp/**,.claude/**,docs/**,README.md,.env.example,ENV_VARS_REFERENCE.md,START_HERE.md,RECOVERY_CHECKLIST.md,RECOVERY_SUMMARY.md,SECURITY_IMPLEMENTATION_SUMMARY.md"

  # Public keys to exclude from secret scanning
  # Rationale for each exclusion:
  # - NEXT_PUBLIC_* variables: Intentionally public (Next.js convention)
  # - NEXT_PUBLIC_SUPABASE_URL: Public Supabase project URL
  # - NEXT_PUBLIC_SUPABASE_ANON_KEY: Public anonymous key (protected by RLS)
  # - NEXT_PUBLIC_CLERK_*: Public Clerk configuration
  # - NEXT_PUBLIC_SITE_URL, NEXT_PUBLIC_APP_URL: Public URLs
  # - NEXT_PUBLIC_APP_NAME: Public application name
  # - ADMIN_USER_IDS: Clerk user IDs (not sensitive, publicly visible in UI)
  # - NODE_VERSION: Build configuration
  # - NPM_FLAGS: Build configuration
  SECRETS_SCAN_OMIT_KEYS = "NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL,NEXT_PUBLIC_CLERK_SIGN_UP_URL,NEXT_PUBLIC_APP_NAME,NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL,NEXT_PUBLIC_CLERK_SIGN_IN_URL,NEXT_PUBLIC_SITE_URL,NEXT_PUBLIC_APP_URL,NEXT_PUBLIC_SUPABASE_URL,NEXT_PUBLIC_SUPABASE_ANON_KEY,NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY,NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,NEXT_PUBLIC_SENTRY_DSN,NEXT_PUBLIC_GA_MEASUREMENT_ID,NEXT_PUBLIC_POSTHOG_KEY,NEXT_PUBLIC_POSTHOG_HOST,NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION,NEXT_PUBLIC_BING_SITE_VERIFICATION,ADMIN_USER_IDS,NODE_VERSION,NPM_FLAGS,NODE_ENV,NEXT_TELEMETRY_DISABLED,UPSTASH_REDIS_REST_URL,UPSTASH_REDIS_REST_TOKEN,CI"

# ============================================
# Context-Specific Configurations
# ============================================

# Production Context
[context.production]
  command = "npm run build:production"
  [context.production.environment]
    NODE_ENV = "production"
    # Production-specific optimizations
    NEXT_TELEMETRY_DISABLED = "1"
    # Enable all production security checks
    SECRETS_SCAN_ENABLED = "true"

# Deploy Preview Context (PR previews)
[context.deploy-preview]
  command = "npm run build"
  [context.deploy-preview.environment]
    NODE_ENV = "production"
    SECRETS_SCAN_ENABLED = "false"

# Branch Deploy Context
[context.branch-deploy]
  command = "npm run build"
  [context.branch-deploy.environment]
    NODE_ENV = "development"
    SECRETS_SCAN_ENABLED = "false"

# Redirect rules for SEO
[[redirects]]
  from = "/sitemap_index.xml"
  to = "/sitemap.xml"
  status = 301

[[redirects]]
  from = "/sitemap-index.xml"
  to = "/sitemap.xml"
  status = 301

# Headers for security and SEO
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "geolocation=(), microphone=(), camera=(), payment=(), usb=()"

[[headers]]
  for = "/_next/static/css/*"
  [headers.values]
    Content-Type = "text/css; charset=utf-8"
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/sitemap.xml"
  [headers.values]
    Content-Type = "application/xml; charset=utf-8"
    Cache-Control = "public, max-age=3600, s-maxage=3600"

[[headers]]
  for = "/robots.txt"
  [headers.values]
    Content-Type = "text/plain; charset=utf-8"
    Cache-Control = "public, max-age=86400, s-maxage=86400"

# Dynamic routes - no HTML caching to prevent serving stale page data
# These routes use SSR and must fetch fresh data based on URL parameters
[[headers]]
  for = "/judges"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate, s-maxage=0"
    X-Robots-Tag = "index, follow"

# API routes with query parameters - ensure proper cache key variation
# Critical for pagination: CDN must include query params in cache key
[[headers]]
  for = "/api/judges/list"
  [headers.values]
    # Netlify-specific: Include query parameters in CDN cache key
    # This ensures /api/judges/list?page=1 and ?page=2 are cached separately
    Netlify-Vary = "query"
    X-Robots-Tag = "noindex, nofollow"

# ============================================
# Serverless Functions Configuration
# ============================================

[functions]
  # Function bundler and optimization
  node_bundler = "esbuild"
  external_node_modules = ["@supabase/supabase-js", "@google/generative-ai", "sharp"]

  # Function timeouts (max 26 seconds for standard functions)
  # Background functions can run up to 15 minutes
  # NOTE: Routes with maxDuration > 26 should be background functions
  [functions.timeout]
    default = 10  # 10 seconds default
    api = 26      # Standard API endpoints (max for non-background)

# Long-running sync functions (background mode)
# These routes have maxDuration = 300 (5 minutes) in code
[functions."api/sync/courts/route"]
  node_bundler = "esbuild"
  [[functions."api/sync/courts/route".timeout]]
    maxDuration = 300  # 5 minutes

[functions."api/sync/judges/route"]
  node_bundler = "esbuild"
  [[functions."api/sync/judges/route".timeout]]
    maxDuration = 300  # 5 minutes

[functions."api/sync/queue/process/route"]
  node_bundler = "esbuild"
  [[functions."api/sync/queue/process/route".timeout]]
    maxDuration = 300  # 5 minutes

# Cron Jobs (scheduled background functions)
[functions."api/cron/daily-sync/route"]
  schedule = "0 2 * * *"  # Daily at 2:00 AM UTC
  node_bundler = "esbuild"

[functions."api/cron/weekly-sync/route"]
  schedule = "0 3 * * 0"  # Weekly on Sunday at 3:00 AM UTC
  node_bundler = "esbuild"

[functions."api/cron/cleanup-checkouts/route"]
  schedule = "0 4 * * *"  # Daily at 4:00 AM UTC (cleanup expired checkouts)
  node_bundler = "esbuild"

# Legacy scheduled function (kept for compatibility)
[functions."submit-sitemap"]
  schedule = "@weekly"

# ============================================
# Post-Processing & Optimization
# ============================================

[build.processing]
  skip_processing = false

[build.processing.css]
  bundle = true
  minify = true

[build.processing.js]
  bundle = true
  minify = true

[build.processing.html]
  pretty_urls = true

[build.processing.images]
  compress = true

# ============================================
# Plugin Configuration
# ============================================

[[plugins]]
  package = "@netlify/plugin-nextjs"

# ============================================
# Edge Functions & Middleware
# ============================================
# Next.js middleware is automatically handled by @netlify/plugin-nextjs
# Custom edge functions can be added to netlify/edge-functions/

# ============================================
# Environment Context Overrides
# ============================================

# Staging/Preview Environment (if using branch deploys)
[context.staging]
  command = "npm run build"
  [context.staging.environment]
    NODE_ENV = "production"
    NEXT_PUBLIC_APP_NAME = "JudgeFinder Platform (Staging)"

# ============================================
# Split Testing (A/B Testing)
# ============================================
# Uncomment to enable A/B testing between branches
# [[context.production.split]]
#   id = "feature-test"
#   branches = ["main", "feature-branch"]
#   weight = [90, 10]  # 90% main, 10% feature-branch

# ============================================
# Build Performance & Caching
# ============================================
# Next.js cache is automatically managed by @netlify/plugin-nextjs
# Additional caching can be configured here if needed
